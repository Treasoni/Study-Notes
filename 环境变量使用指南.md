---
title: 环境变量使用指南
date: 2026-02-13
tags:
  - 编程
  - 系统配置
  - AI开发
  - DevOps
status: done
level: 中级
---

# 环境变量使用指南

> [!info] 概述
> 环境变量是操作系统中存储配置信息的动态命名值。它们可以在进程间传递，影响程序的行为和运行环境。

---

## 核心概念

### 什么是环境变量？

环境变量就像是程序的"全局配置字典"：
- **键值对存储**：每个变量都有一个名称和一个值
- **进程继承**：子进程会继承父进程的环境变量
- **动态性**：可以在运行时读取，但通常是进程启动时设置

> [!tip】 为什么需要环境变量？
> - **配置分离**：代码和配置分离，便于管理不同环境
> - **安全性**：敏感信息（如API密钥）不直接写入代码
> - **灵活性**：同一套代码，不同环境使用不同配置
> - **标准化**：操作系统和程序通过环境变量进行交互

### 环境变量的生命周期

```
系统启动
  ↓
系统级环境变量设置（所有用户）
  ↓
用户登录
  ↓
用户级环境变量设置（当前用户）
  ↓
Shell/终端启动
  ↓
会话级环境变量设置（当前会话）
  ↓
程序运行（继承环境变量）
```

---

## 各操作系统使用方法

### Windows

#### 命令行查看和设置

```batch
REM 查看所有环境变量
set

REM 查看特定环境变量
echo %PATH%
echo %API_KEY%

REM 临时设置（仅当前会话有效）
set MY_VAR=hello

REM 永久设置（用户级）
setx MY_VAR "hello"

REM 永久设置（系统级，需要管理员权限）
setx MY_VAR "hello" /M
```

#### GUI 设置方式

1. **Win + R** → 输入 `sysdm.cpl`
2. 点击"环境变量"
3. 分为"用户变量"和"系统变量"两部分
4. 新建、编辑或删除环境变量

#### PowerShell

```powershell
# 查看所有环境变量
Get-ChildItem Env:

# 查看特定环境变量
$env:PATH
$env:API_KEY

# 临时设置
$env:MY_VAR = "hello"

# 永久设置（用户级）
[Environment]::SetEnvironmentVariable("MY_VAR", "hello", "User")

# 永久设置（系统级）
[Environment]::SetEnvironmentVariable("MY_VAR", "hello", "Machine")
```

### macOS

#### 查看和设置

```bash
# 查看所有环境变量
printenv
# 或
env

# 查看特定环境变量
echo $PATH
echo $API_KEY

# 临时设置（仅当前会话有效）
export MY_VAR="hello"

# 查看变量类型（环境变量 vs Shell变量）
typeset MY_VAR
```

#### 永久设置（用户级）

编辑 `~/.zshrc`（zsh，macOS默认）或 `~/.bash_profile`（bash）：

```bash
# ~/.zshrc
export MY_VAR="hello"
export PATH="$HOME/custom/bin:$PATH"

# 加载配置
source ~/.zshrc
```

#### 系统级设置

编辑 `/etc/launchd.conf` 或创建 `/Library/LaunchDaemons/` 下的 plist 文件。

### Linux

#### 查看和设置

```bash
# 查看所有环境变量
printenv
env

# 查看特定环境变量
echo $PATH

# 临时设置
export MY_VAR="hello"

# 临时设置（仅当前命令）
MY_VAR="hello" command

# 取消设置
unset MY_VAR
```

#### 永久设置（用户级）

```bash
# 编辑 ~/.bashrc 或 ~/.bash_profile
nano ~/.bashrc

# 添加
export MY_VAR="hello"
export PATH="$HOME/bin:$PATH"

# 立即生效
source ~/.bashrc
```

#### 系统级设置

```bash
# 编辑 /etc/environment（所有用户，所有Shell）
sudo nano /etc/environment

# 或编辑 /etc/profile
sudo nano /etc/profile
```

### 各系统对比

| 操作系统 | 临时设置 | 永久设置（用户） | 永久设置（系统） | 查看命令 |
|---------|---------|------------------|------------------|---------|
| **Windows** | `set VAR=val` | `setx VAR val` | `setx VAR val /M` | `set` |
| **PowerShell** | `$env:VAR=val` | `[Environment]::SetEnvironmentVariable("VAR", "val", "User")` | `...("Machine")` | `Get-ChildItem Env:` |
| **macOS** | `export VAR=val` | `~/.zshrc` | `/etc/launchd.conf` | `printenv` |
| **Linux** | `export VAR=val` | `~/.bashrc` | `/etc/environment` | `printenv` |

---

## 编程语言中读取环境变量

### Python

```python
import os
from dotenv import load_dotenv  # 需要 pip install python-dotenv

# 加载 .env 文件
load_dotenv()

# 读取环境变量
api_key = os.getenv("API_KEY")
database_url = os.getenv("DATABASE_URL")

# 带默认值
timeout = int(os.getenv("TIMEOUT", "30"))

# 检查变量是否存在
if "API_KEY" not in os.environ:
    raise ValueError("API_KEY 未设置")

# 设置环境变量（仅当前进程）
os.environ["MY_VAR"] = "value"
```

### JavaScript/Node.js

```javascript
// 加载 .env 文件
require('dotenv').config();

// 读取环境变量
const apiKey = process.env.API_KEY;
const databaseUrl = process.env.DATABASE_URL;

// 带默认值
const timeout = parseInt(process.env.TIMEOUT || '30');

// 检查变量是否存在
if (!process.env.API_KEY) {
  throw new Error('API_KEY 未设置');
}

// 设置环境变量
process.env.MY_VAR = 'value';
```

### Go

```go
package main

import (
    "fmt"
    "os"
    "strconv"
)

func main() {
    // 读取环境变量
    apiKey := os.Getenv("API_KEY")
    databaseUrl := os.Getenv("DATABASE_URL")

    // 带默认值
    timeout := 30
    if t, err := strconv.Atoi(os.Getenv("TIMEOUT")); err == nil {
        timeout = t
    }

    // 检查变量是否存在
    if _, exists := os.LookupEnv("API_KEY"); !exists {
        panic("API_KEY 未设置")
    }

    // 设置环境变量
    os.Setenv("MY_VAR", "value")

    // 获取所有环境变量
    for _, env := range os.Environ() {
        fmt.Println(env)
    }
}
```

### Java

```java
import java.util.Map;
import java.util.Optional;

public class EnvExample {
    public static void main(String[] args) {
        // 读取环境变量
        String apiKey = System.getenv("API_KEY");
        String databaseUrl = System.getenv("DATABASE_URL");

        // 带默认值
        int timeout = Optional.ofNullable(System.getenv("TIMEOUT"))
            .map(Integer::parseInt)
            .orElse(30);

        // 检查变量是否存在
        if (apiKey == null) {
            throw new RuntimeException("API_KEY 未设置");
        }

        // 获取所有环境变量
        Map<String, String> env = System.getenv();
        env.forEach((key, value) -> System.out.println(key + "=" + value));
    }
}
```

---

## AI 开发中的常见使用场景

### 1. API 密钥管理

> [!warning] 安全原则
> **永远不要**将 API 密钥硬编码到代码中或提交到版本控制！

```bash
# .env 文件（添加到 .gitignore）
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
HUGGINGFACE_TOKEN=hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

```python
# config.py
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
    ANTHROPIC_API_KEY = os.getenv("ANTHROPIC_API_KEY")
    HUGGINGFACE_TOKEN = os.getenv("HUGGINGFACE_TOKEN")

    # 验证必需的密钥
    @classmethod
    def validate(cls):
        if not cls.OPENAI_API_KEY:
            raise ValueError("OPENAI_API_KEY 未设置")
```

### 2. 模型配置

```bash
# .env
MODEL_NAME=gpt-4
TEMPERATURE=0.7
MAX_TOKENS=2048
TOP_P=0.9
FREQUENCY_PENALTY=0.5
```

```python
# 使用
model = Model(
    name=os.getenv("MODEL_NAME", "gpt-3.5-turbo"),
    temperature=float(os.getenv("TEMPERATURE", "0.7")),
    max_tokens=int(os.getenv("MAX_TOKENS", "2048"))
)
```

### 3. 路径和目录管理

```bash
# .env
PROJECT_ROOT=/path/to/project
DATA_DIR=data
MODELS_DIR=models
CACHE_DIR=.cache
LOG_DIR=logs
OUTPUT_DIR=outputs
```

```python
# 使用 pathlib 构建路径
from pathlib import Path

BASE_DIR = Path(os.getenv("PROJECT_ROOT", Path(__file__).parent))
DATA_DIR = BASE_DIR / os.getenv("DATA_DIR", "data")
MODELS_DIR = BASE_DIR / os.getenv("MODELS_DIR", "models")

# 确保目录存在
DATA_DIR.mkdir(parents=True, exist_ok=True)
MODELS_DIR.mkdir(parents=True, exist_ok=True)
```

### 4. 数据库和存储配置

```bash
# .env
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
REDIS_URL=redis://localhost:6379/0
MONGODB_URI=mongodb://localhost:27017/mydb
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1
S3_BUCKET=my-bucket
```

### 5. 环境区分

```bash
# 开发环境
ENV=development
DEBUG=true
LOG_LEVEL=debug

# 生产环境
ENV=production
DEBUG=false
LOG_LEVEL=info
```

```python
# 根据环境加载不同配置
import os

ENV = os.getenv("ENV", "development")
DEBUG = os.getenv("DEBUG", "false").lower() == "true"

if ENV == "development":
    DATABASE_URL = "sqlite:///dev.db"
else:
    DATABASE_URL = os.getenv("DATABASE_URL")
```

### 6. GPU 和资源配置

```bash
# .env
CUDA_VISIBLE_DEVICES=0,1
OMP_NUM_THREADS=4
MKL_NUM_THREADS=4
PYTORCH_CUDA_ALLOC_CONF=garbage_collection_threshold:0.8
```

### 7. 日志和监控配置

```bash
# .env
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
LOG_FORMAT=json
SENTRY_DSN=https://xxxxxxxxxxxxx@sentry.io/xxxxxxx
```

---

## 最佳实践

### 1. 使用 .env 文件

```bash
# .gitignore
.env
.env.local
.env.production
.env.secrets
```

```python
# .env.example（提交到版本控制）
OPENAI_API_KEY=your_openai_api_key_here
DATABASE_URL=postgresql://user:password@localhost/db
```

### 2. 配置验证

```python
from typing import TypeVar, Generic
import os

T = TypeVar('T')

class ConfigVar(Generic[T]):
    def __init__(self, name: str, default: T = None, required: bool = False, type_func: callable = None):
        self.name = name
        self.default = default
        self.required = required
        self.type_func = type_func or (lambda x: x)

    def get(self) -> T:
        value = os.getenv(self.name)

        if value is None:
            if self.required:
                raise ValueError(f"Required environment variable {self.name} is not set")
            return self.default

        return self.type_func(value)

# 使用
API_KEY = ConfigVar("API_KEY", required=True)
PORT = ConfigVar("PORT", default=8000, type_func=int)
DEBUG = ConfigVar("DEBUG", default=False, type_func=lambda x: x.lower() == "true")
```

### 3. 配置分层

```
配置优先级（从高到低）：
1. 命令行参数
2. 环境变量
3. 配置文件
4. 默认值
```

```python
import argparse
from dotenv import load_dotenv

load_dotenv()

# 默认配置
config = {
    "port": 8000,
    "debug": False
}

# 从环境变量覆盖
config["port"] = int(os.getenv("PORT", config["port"]))
config["debug"] = os.getenv("DEBUG", str(config["debug"])).lower() == "true"

# 从命令行参数覆盖
parser = argparse.ArgumentParser()
parser.add_argument("--port", type=int, default=config["port"])
parser.add_argument("--debug", action="store_true")
args = parser.parse_args()

config["port"] = args.port
config["debug"] = args.debug
```

### 4. 敏感信息处理

> [!danger] 安全警告
> - 使用 secrets 管理工具（如 HashiCorp Vault、AWS Secrets Manager）
> - CI/CD 中使用加密 secrets 功能
> - 定期轮换密钥
> - 最小权限原则

### 5. 类型转换和验证

```python
import os
from typing import Any, Callable, TypeVar
from enum import Enum

T = TypeVar('T')

class LogLevel(Enum):
    DEBUG = "debug"
    INFO = "info"
    WARNING = "warning"
    ERROR = "error"

def get_env(
    name: str,
    default: T = None,
    required: bool = False,
    parser: Callable[[str], T] = None
) -> T:
    value = os.getenv(name)

    if value is None:
        if required:
            raise ValueError(f"Required environment variable {name} is not set")
        return default

    if parser:
        return parser(value)

    return value

# 使用示例
PORT = get_env("PORT", default=8000, parser=int)
LOG_LEVEL = get_env("LOG_LEVEL", default="info", parser=LogLevel)
DEBUG = get_env("DEBUG", default=False, parser=lambda x: x.lower() == "true")
```

---

## 常见环境变量

### 系统标准变量

| 变量名 | 用途 | 示例值 |
|--------|------|--------|
| `PATH` | 可执行文件搜索路径 | `/usr/bin:/bin:/usr/local/bin` |
| `HOME` | 用户主目录 | `/home/user` 或 `C:\Users\user` |
| `USER` | 当前用户名 | `john` |
| `SHELL` | 默认 Shell | `/bin/zsh` |
| `LANG` | 语言和地区设置 | `zh_CN.UTF-8` |
| `TERM` | 终端类型 | `xterm-256color` |
| `PWD` | 当前工作目录 | `/home/user/project` |
| `TMPDIR` | 临时文件目录 | `/tmp` |

### AI 开发常用变量

| 变量名 | 用途 |
|--------|------|
| `OPENAI_API_KEY` | OpenAI API 密钥 |
| `ANTHROPIC_API_KEY` | Anthropic API 密钥 |
| `HUGGINGFACE_TOKEN` | Hugging Face 访问令牌 |
| `CUDA_VISIBLE_DEVICES` | 指定可见的 GPU |
| `TRANSFORMERS_CACHE` | Transformers 模型缓存目录 |
| `HF_HOME` | Hugging Face 配置目录 |
| `PYTHONPATH` | Python 模块搜索路径 |
| `VIRTUAL_ENV` | 虚拟环境路径 |
| `CONDA_PREFIX` | Conda 环境路径 |

---

## 常见问题排查

### 环境变量未生效

```bash
# 1. 检查是否在当前会话中设置
echo $MY_VAR

# 2. 检查是否使用 export（bash/zsh）
# 错误：MY_VAR=value（仅对当前命令有效）
# 正确：export MY_VAR=value

# 3. 检查 shell 配置文件
cat ~/.zshrc
cat ~/.bashrc

# 4. 重新加载配置
source ~/.zshrc
source ~/.bashrc

# 5. 检查父进程
ps -p $$
pstree -p $$
```

### Python 中找不到环境变量

```python
# 1. 检查 .env 文件是否存在
import os
print(os.path.exists(".env"))

# 2. 检查 dotenv 是否正确加载
from dotenv import load_dotenv, find_dotenv
env_path = find_dotenv()
print(f"找到 .env 文件: {env_path}")
load_dotenv(env_path)

# 3. 打印所有环境变量
import os
for key, value in os.environ.items():
    print(f"{key}={value}")
```

### 路径问题

```bash
# Windows 路径分隔符问题
# 在 .env 文件中使用正斜杠，Python 会自动处理
DATA_DIR=C:/Users/user/project/data

# 或使用双反斜杠
DATA_DIR=C:\\Users\\user\\project\\data

# 或使用引号
DATA_DIR="C:\Users\user\project\data"
```

---

## 安全检查清单

> [!check] 部署前检查
>
> - [ ]`.env` 文件已添加到 `.gitignore`
> - [ ] 敏感信息（API 密钥、密码）未硬编码
> - [ ] `.env.example` 已创建并提交
> - [ ] CI/CD 配置使用 secrets 管理敏感信息
> - [ ] 生产环境配置与开发环境分离
> - [ ] 密钥轮换机制已建立
> - [ ] 访问日志和审计已配置

---

## 参考资源

- [Python dotenv 文档](https://github.com/theskumar/python-dotenv)
- [Node.js dotenv 文档](https://github.com/motdotla/dotenv)
- [12-Factor App - 配置](https://12factor.net/config)
- [OWASP 环境变量安全](https://owasp.org/www-community/vulnerabilities/Environment_Variable_Manipulation)
