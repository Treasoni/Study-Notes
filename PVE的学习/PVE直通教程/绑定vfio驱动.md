
**vfio ç»‘å®šæ˜¯å¹²å˜›çš„ï¼Ÿï¼ˆä¸€å¥è¯ç‰ˆï¼‰**

> **vfio ç»‘å®š = æŠŠæŸä¸ªç¡¬ä»¶è®¾å¤‡â€œä»å®¿ä¸»æœºæ‰‹é‡ŒæŠ¢èµ°â€ï¼Œä¸“é—¨ç•™ç»™è™šæ‹Ÿæœºç”¨**

**ç”¨ä¸€å¥éå¸¸å½¢è±¡çš„è¯è¯´**

- **ä¸ç»‘å®š vfio**ï¼š  
    ğŸ‘‰ è®¾å¤‡é»˜è®¤å½’ **PVEï¼ˆå®¿ä¸»æœº Linuxï¼‰** ç”¨
- **ç»‘å®š vfio**ï¼š  
    ğŸ‘‰ è®¾å¤‡è¢«â€œå°å°â€ï¼Œå®¿ä¸»æœºä¸ç”¨  
    ğŸ‘‰ **åªèƒ½è¢«è™šæ‹Ÿæœºä½¿ç”¨**

# 1. Linux ä¸–ç•Œé‡Œè®¾å¤‡çš„â€œå½’å±æƒâ€

æ¯ä¸€ä¸ª PCI è®¾å¤‡ **åªèƒ½è¢«ä¸€ä¸ªé©±åŠ¨å ç”¨**ï¼š

|é©±åŠ¨|è§’è‰²|
|---|---|
|i915|Intel æ ¸æ˜¾|
|r8169|Realtek ç½‘å¡|
|xhci_hcd|USB æ§åˆ¶å™¨|
|ahci|SATA|
|**vfio-pci**|è™šæ‹Ÿæœºä¸“ç”¨â€œå å‘é©±åŠ¨â€|

ğŸ‘‰ **vfio-pci çš„å”¯ä¸€ç›®çš„ï¼šå ä½è®¾å¤‡ï¼Œä¸è®©å®¿ä¸»æœºç¢°**

# 2. ä¸ºä»€ä¹ˆä¸€å®šè¦ç»‘å®š vfioï¼Ÿ

å¦‚æœä½ **ä¸ç»‘å®š**ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

## 2.1 ä¾‹å­ï¼šç›´é€šæ ¸æ˜¾ï¼ˆæˆ–ç½‘å¡ / USBï¼‰

å¯åŠ¨é¡ºåºæ˜¯è¿™æ ·çš„ï¼š

1ï¸âƒ£ PVE å¯åŠ¨  
2ï¸âƒ£ Linux å†…æ ¸åŠ è½½é»˜è®¤é©±åŠ¨

- æ ¸æ˜¾ â†’ `i915`
- ç½‘å¡ â†’ `r8169`  
    3ï¸âƒ£ è®¾å¤‡ **å·²ç»è¢«å®¿ä¸»æœºå ç”¨**  
    4ï¸âƒ£ VM å¯åŠ¨æƒ³è¦è¿™ä¸ªè®¾å¤‡  
    ğŸ‘‰ âŒ **æ‹¿ä¸åˆ° / æŠ¥é”™ / é»‘å±**

**ç»‘å®š vfio åï¼Œé¡ºåºå˜æˆï¼š**

1ï¸âƒ£ PVE å¯åŠ¨  
2ï¸âƒ£ vfio-pci **æå‰ç»‘å®šè®¾å¤‡**  
3ï¸âƒ£ é»˜è®¤é©±åŠ¨ï¼ˆi915 / r8169ï¼‰**æ ¹æœ¬æ²¡æœºä¼šåŠ è½½**  
4ï¸âƒ£ VM å¯åŠ¨  
ğŸ‘‰ âœ… è®¾å¤‡æ˜¯â€œç©ºçš„â€ï¼Œå¯ä»¥ç›´æ¥ç”¨

> [!important]

> â­ 
> **IOMMU å†³å®šâ€œèƒ½ä¸èƒ½ç›´é€šâ€  
> vfio å†³å®šâ€œè°æ¥ç”¨â€**

# 3. ä»€ä¹ˆæ—¶å€™â€œå¿…é¡»â€ç»‘å®š vfioï¼Ÿ

## 3.1 âœ… å¿…é¡»ç»‘å®šçš„æƒ…å†µ

- PCIe ç›´é€šï¼š
    - GPU
    - ç‹¬ç«‹ USB å¡
    - ç‹¬ç«‹ç½‘å¡
    - HBA / RAID å¡

ğŸ‘‰ **100% è¦ç»‘å®š**

## 3.2 âŒ ä¸éœ€è¦ç»‘å®šçš„æƒ…å†µ

- ä½ åªæ˜¯ï¼š
    - ç”¨å®¿ä¸»æœºæ ¸æ˜¾ç¡¬è§£
    - Docker / CT ç”¨ `/dev/dri`
- æ²¡æœ‰åš PCI Passthrough

# 4. vfio ç»‘å®šçš„å®Œæ•´è¿‡ç¨‹ï¼ˆPVE æ ‡å‡†åšæ³•ï¼‰

âš ï¸ å‰æï¼š

- è®¾å¤‡ **å·²ç»åœ¨ç‹¬ç«‹ IOMMU Group**
- å¦åˆ™ **ä¸è¦ç»‘**

## 4.1 ç¬¬ 1 æ­¥ï¼šç¡®è®¤è®¾å¤‡ PCI ID

```bash
lspci -nn
```

ç¤ºä¾‹ï¼š

```bash
01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP106 [10de:1c03]
01:00.1 Audio device [0403]: NVIDIA Corporation GP106 HDMI Audio [10de:10f1]
```

ğŸ‘‰ **è®°ä½ä¸­æ‹¬å·é‡Œçš„ `å‚å•†ID:è®¾å¤‡ID`**

## 4.2 ç¬¬ 2 æ­¥ï¼šåŠ è½½ vfio æ¨¡å—

```bash
nano /etc/modules
```

åŠ å…¥ï¼š

```bash
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```


## 4.3 ç¬¬ 3 æ­¥ï¼šæŒ‡å®šå“ªäº›è®¾å¤‡ç”¨ vfio-pci

```bash
nano /etc/modprobe.d/vfio.conf
```

å†™å…¥ï¼š

```bash
options vfio-pci ids=10de:1c03,10de:10f1
```

ğŸ‘‰ å¤šä¸ªè®¾å¤‡ç”¨é€—å·åˆ†éš”

## 4.4 ç¬¬ 4 æ­¥ï¼ˆéå¸¸é‡è¦ï¼‰ï¼šç¦æ­¢å®¿ä¸»æœºåŸé©±åŠ¨åŠ è½½

**ä¾‹ï¼šæ ¸æ˜¾ / æ˜¾å¡**

```bash
nano /etc/modprobe.d/blacklist.conf
```

å†™ï¼š

```bash
blacklist nouveau
blacklist nvidia
blacklist i915   # åªæœ‰ä½ çœŸè¦ç›´é€šæ ¸æ˜¾æ‰åŠ 
```

âš ï¸ **ä¸è¦éšä¾¿ blacklist i915**  
ğŸ‘‰ å¦åˆ™å®¿ä¸»æœºæ²¡æ˜¾ç¤º


## ç¬¬ 5 æ­¥ï¼šæ›´æ–° initramfs

`update-initramfs -u -k all`

---

## ç¬¬ 6 æ­¥ï¼šé‡å¯

`reboot`

---

## ç¬¬ 7 æ­¥ï¼šç¡®è®¤ç»‘å®šæˆåŠŸï¼ˆä¸€å®šè¦åšï¼‰

`lspci -nnk -s 01:00.0`

æ­£ç¡®ç»“æœï¼š

`Kernel driver in use: vfio-pci`

å¦‚æœè¿˜æ˜¯ï¼š

`Kernel driver in use: i915 / r8169`

ğŸ‘‰ ç»‘å®šå¤±è´¥ï¼Œ**ä¸èƒ½ç›´é€š**

---