---
tags: [pve]
---

# PVE 网络逻辑详解

> [!info] 概述
> PVE 的网络基于 Linux Bridge 技术，通过网桥（vmbr）连接虚拟机和物理网络，实现虚拟机与外界通信。
> 类比：vmbr 就像一台"虚拟交换机"，虚拟机通过"虚拟网卡"插在这台交换机上，再连接到物理网络。

## 核心概念 💡
- **网桥（Bridge/vmbr）**：虚拟二层交换机，做 MAC 转发
- **直通（Passthrough）**：物理网卡完全交给某个 VM 独占
- **虚拟网卡（vNIC）**：给虚拟机用的网卡，VirtIO 性能最优
- **内交换**：流量不出宿主机，VM 之间直接通信
- **外交换**：流量走物理网络，经过路由器

## 网桥（Bridge / vmbr）

### 它是什么？

**vmbr = Linux Bridge = 二层交换机**

👉 本质：
- 不做 NAT
- 不做路由
- 只做 **MAC 转发**

### 网络拓扑图

```
[ 物理网线 ]
     │
[ 物理网卡 eno1 ]
     │
┌───────────────┐
│   Linux Bridge│  ← vmbr0（虚拟交换机）
└───────────────┘
   │        │
[ vNIC ]  [ vNIC ]
  VM1       VM2
```

### 直通对照

```
[ 物理网卡 eno2 ] ─── 直通 ───> VM（独占）
```

### 现实类比

想象你桌子上有一个：
> **5 口千兆交换机**

- 插了：
  - 一根网线（物理网卡）
  - 几台电脑（虚拟机）

这台交换机 = `vmbr0`

### 关键特性

| 特性 | 说明 |
|------|------|
| 工作层级 | OSI 第二层（数据链路层） |
| VM 可见性 | VM 看不到宿主机存在 |
| 网络行为 | 跟接在实体交换机上**没有区别** |
| IP 地址 | VM 拿真实 IP（192.168.x.x） |

### 为什么 PVE 必须用网桥？

因为虚拟机需要：
- 拿真实 IP（192.168.x.x）
- 被路由器当成真实设备
- 与网络中其他设备直接通信

## 直通（PCI Passthrough / 网卡直通）

### 它是什么？

**把一张"真实物理网卡"完全交给某个 VM**

| 宿主机 | 虚拟机 |
|--------|--------|
| ❌ 不再拥有 | ✅ 当成"原生网卡" |
| ❌ 看不见 | ✅ 独占使用 |
| ❌ 不能用 | ✅ 性能最优 |

### 现实类比

你从主板上：
- 拔下一张网卡
- 插进另一台电脑

### 典型用途

| 场景 | 说明 |
|------|------|
| 软路由 | iStoreOS/OpenWRT 独占网卡 |
| 防火墙 | pfSense/OPNsense |
| 高性能网络 | 需要原生网卡性能 |
| PPPoE 拨号 | 运营商拨号 |

### 直通的代价

| 优点 | 缺点 |
|------|------|
| 性能最好 | 宿主机失去该网卡 |
| 网络最干净 | 不灵活 |
| 不走 vmbr | 不能和其他 VM 共用 |

## 虚拟网卡（vNIC）

### 它是什么？

**给虚拟机用的"网卡"**

在 PVE 里你会看到：
- **VirtIO**（推荐）⭐⭐⭐
- Intel E1000
- Realtek（不推荐）

### 现实类比

你在电脑主板上插了一张：
> PCIe 网卡

只不过：
- 这是 **虚拟的**
- 插在 **vmbr 上**

### 特点

| 特性 | 说明 |
|------|------|
| 数量 | 每个 VM 至少一张 |
| MAC 地址 | 每个 vNIC 有独立 MAC |
| IP 地址 | 由 DHCP/静态配置 |
| 最佳性能 | **VirtIO**（半虚拟化） |

### 正确认识网桥和虚拟网卡

> **网桥（vmbr）就是一台二层交换机**
> **网卡（虚拟网卡 vNIC / 物理网卡）就是交换机上的端口**
> **虚拟机通过虚拟网卡"插"在交换机端口上**

## 内交换 / 外交换

### 内交换（Internal Switching）

**流量不出宿主机**

```
VM1 ── vmbr ── VM2
```

| 特性 | 说明 |
|------|------|
| 路径 | 不经过物理网卡 |
| 路径 | 不经过路由器 |
| 延迟 | 极低 |
| 速度 | 取决于内存带宽 |

🧠 类比：同一个交换机下，两台电脑互 ping

**典型场景**：
- 软路由（RouterOS）↔ NAS（飞牛）
- 应用服务器 ↔ 数据库服务器

### 外交换（External Switching）

**流量走物理网络**

```
VM ─ vmbr ─ eno1 ─ 路由器 ─ 互联网
```

| 特性 | 说明 |
|------|------|
| 路径 | 出 PVE |
| 路径 | 走交换机/路由器 |
| 延迟 | 取决于物理网络 |
| 速度 | 取决于物理网卡 |

**典型场景**：
- VM 访问互联网
- VM 访问其他物理设备
- VM 从外面访问

### 什么时候是内交换？

| 条件 | 说明 |
|------|------|
| 同一个 vmbr | 在同一个网桥上 |
| 同一个宿主机 | 不跨节点 |
| 不访问外部 IP | 目标 IP 在本地网络 |

## 网络类型对比

| 类型 | 特点 | 适合场景 |
|------|------|----------|
| 网桥（vmbr） | 二层交换机，不 NAT | 多个 VM 共享网络 |
| 直通 | 物理网卡独占，性能最好 | 软路由、防火墙 |
| 虚拟网卡（vNIC） | VirtIO 性能最优 | 通用 VM 网络 |

## 注意事项 ⚠️

1. **网桥名称**
   - 默认 `vmbr0`、`vmbr1` 等
   - 可以自定义，但建议保持规范

2. **网卡名要真实存在**
   - 用 `ip link` 查看真实网卡名
   - 配置文件中要用真实名称

3. **直通网卡宿主机不可用**
   - 直通后宿主机看不到这张网卡
   - 至少留一张网卡给宿主机

4. **VirtIO 需要驱动支持**
   - Linux 原生支持
   - Windows 需要安装 VirtIO 驱动

## 常见问题 ❓

**Q: vmbr 和物理网卡是什么关系？**
A: vmbr 是虚拟交换机，物理网卡是连接到这台交换机的"上行端口"。

**Q: 直通和网桥选哪个？**
A: 性能要求高用直通（软路由），通用场景用网桥。

**Q: VirtIO 和 E1000 哪个好？**
A: VirtIO 性能最好，需要驱动支持；E1000 兼容性好但性能差。

**Q: 如何判断是内交换还是外交换？**
A: 看 IP 地址：同一网段且在同一宿主机是内交换，需要经过路由器是外交换。

**Q: 可以同时用网桥和直通吗？**
A: 可以，但需要多张网卡。一张直通给 VM，一张给宿主机/网桥。

**Q: VM 之间通信为什么这么快？**
A: 因为是内交换，流量只在内存中传输，不经过物理网络。

## 相关文档

[[修改PVE的网络信息]] | [[如何创建PVE虚拟机]] | [[PVE直通]] | [[安装和使用PVE]] | [[PVE学习笔记MOC]]
