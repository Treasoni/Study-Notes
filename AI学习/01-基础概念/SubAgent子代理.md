---
tags: [ai, 基础概念, subagent]
---

# SubAgent 子代理

> [!info] 概述
> **SubAgent 是"外包员工"** - 主 Agent 派活给它，它在独立的办公室（独立上下文）里干活，只汇报结果。适合需要深度思考、上下文隔离的复杂任务。

## 核心概念

### 什么是 SubAgent

**定义**：拥有**完全独立上下文**的专用执行单元，由主 Agent 派发任务并独立完成

**核心价值**：
- 🔒 **上下文隔离**：SubAgent 的中间过程不污染主 Agent 的上下文
- ⚡ **并行处理**：多个 SubAgent 可同时处理不同任务
- 🎯 **专业分工**：每个 SubAgent 专注做一件事
- 💰 **成本优化**：可为不同 SubAgent 配置不同成本的模型

**比喻理解**：
```
主 Agent = 老板（在主办公室）
SubAgent = 专业员工（在独立办公室）

老板派活 → 员工在独立空间工作 → 只汇报最终结果
老板的办公室不会被员工的草稿、中间过程弄乱
```

### SubAgent vs Agent 对比

| 维度 | Agent | SubAgent |
|------|-------|----------|
| **上下文** | 共享主上下文 | **完全独立**的上下文空间 |
| **执行方式** | 串行，在主推理流程中展开 | 可并行，独立推理循环 |
| **工具调用** | 通过主 Agent 间接调用 | 可配置专属工具集（白名单/黑名单） |
| **适合任务** | 分析、审查、简单线性任务 | 开发、重构、代码探索等复杂多步骤任务 |
| **资源消耗** | 中等 | 较高（额外协调开销） |
| **Token 成本** | 低 | 较高（独立上下文需要额外 token） |
| **结果返回** | 完整过程可见 | 只返回精简结果 |

### 核心特点

| 特点 | 说明 |
|------|------|
| **上下文隔离** | 中间推理过程不影响主上下文 |
| **独立推理** | 拥有完整的感知-规划-执行-反思循环 |
| **工具配置** | 可配置专属工具集，限制权限 |
| **模型选择** | 可指定使用不同成本的模型 |

---

## 技术细节

### 工作原理图

```
┌─────────────────────────────────────────────────────────────────┐
│                        SUBAGENT 模式                             │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │     主 Agent      │ ← 只接收精简结果，上下文保持干净            │
│  │     (指挥官)      │                                          │
│  └────────┬─────────┘                                           │
│           │                                                      │
│           │ 派发任务（Task + Prompt）                             │
│           │                                                      │
│      ┌────┴────┬──────────┬──────────┐                          │
│      ↓         ↓          ↓          ↓                          │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐                        │
│  │SubA-1 │ │SubA-2 │ │SubA-3 │ │SubA-4 │  ← 各自独立上下文        │
│  │       │ │       │ │       │ │       │                        │
│  │代码   │ │测试   │ │文档   │ │审查   │                        │
│  │探索   │ │生成   │ │编写   │ │检查   │                        │
│  │       │ │       │ │       │ │       │                        │
│  └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘                        │
│      │         │          │          │                           │
│      ↓         ↓          ↓          ↓                           │
│   结果1     结果2      结果3      结果4                          │
│      │         │          │          │                           │
│      └─────────┴──────────┴──────────┘                           │
│                        │                                          │
│                        ↓                                          │
│              精简摘要返回主 Agent                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### SubAgent 的生命周期

```
1. 创建阶段
   └── 主 Agent 决定派发任务，创建 SubAgent

2. 配置阶段
   ├── 指定任务描述（prompt）
   ├── 配置可用工具（allowed-tools）
   └── 选择模型（可选，默认同主模型）

3. 执行阶段
   ├── SubAgent 在独立上下文中推理
   ├── 调用工具完成任务
   └── 内部循环直到任务完成

4. 返回阶段
   ├── SubAgent 生成精简结果摘要
   └── 结果返回给主 Agent

5. 清理阶段
   └── SubAgent 上下文释放
```

### 内置 SubAgent 类型

Claude Code 内置了多种 SubAgent 类型：

| 类型 | 功能 | 典型任务 |
|------|------|----------|
| **general-purpose** | 通用任务代理 | 研究问题、多步骤任务 |
| **Explore** | 代码库探索 | 查找文件、理解架构 |
| **Bash** | 命令执行 | 运行脚本、系统操作 |
| **statusline-setup** | 状态栏配置 | 设置配置项 |
| **Plan** | 架构规划 | 设计实现方案 |
| **claude-code-guide** | 使用指南 | 解答使用问题 |

### 工具权限配置

SubAgent 可以配置专属的工具白名单：

```json
{
  "subagent_type": "code-explorer",
  "allowed_tools": ["Read", "Grep", "Glob"],
  "prompt": "探索代码库，理解项目结构..."
}
```

**常用配置**：

| 任务类型 | 推荐工具配置 |
|----------|-------------|
| 代码审查 | Read, Grep, Glob |
| 代码修改 | Read, Edit, Write, Bash |
| 测试运行 | Read, Bash |
| 文档生成 | Read, Write, Glob |
| 代码探索 | Read, Grep, Glob |

### 成本考量

| 因素 | 影响 |
|------|------|
| **独立上下文** | 需要额外的 token 建立上下文 |
| **模型选择** | 可用 Haiku 降低成本 |
| **任务复杂度** | 复杂任务需要更多推理步骤 |
| **并行数量** | 多个 SubAgent 并行会增加并发成本 |

**成本优化建议**：
- 简单任务不要用 SubAgent
- 为只读任务配置 Haiku 模型
- 避免创建过多并行 SubAgent

---

## 与其他概念的关系

```
┌─────────────────────────────────────────────────────────────┐
│                        主 Agent                              │
│                    (共享主上下文)                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
         派发任务         │
                          │
          ┌───────────────┼───────────────┐
          ↓               ↓               ↓
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │SubAgent-1│    │SubAgent-2│    │SubAgent-3│
    │(独立上下文)│    │(独立上下文)│    │(独立上下文)│
    └──────────┘    └──────────┘    └──────────┘
          │               │               │
          └───────────────┴───────────────┘
                          │
                          ↓
                    结果汇总到主 Agent
```

| 概念 | 与 SubAgent 的关系 |
|------|-------------------|
| [[Agent智能体]] | SubAgent 由 Agent 派发和管理 |
| [[Skills 是什么]] | Skills 共享上下文，SubAgent 独立上下文 |
| [[Agent Teams智能体团队]] | Agent Teams 是多 Agent 协作，SubAgent 是单 Agent 内的子任务 |

### SubAgent vs Skills 对比

| 维度 | Skills | SubAgent |
|------|--------|----------|
| **上下文** | 共享主上下文 | 完全独立 |
| **本质** | 知识注入（内化能力） | 任务外包（独立执行） |
| **适合任务** | 轻量任务、需要专业指导 | 复杂任务、需要上下文隔离 |
| **成本** | 低 | 较高 |
| **触发方式** | 自动/命令触发 | Agent 决策派发 |

---

## 最佳实践

### 何时使用 SubAgent

**✅ 适合使用 SubAgent 的场景**：
- 代码库探索（需要大量阅读文件）
- 大规模重构（中间步骤多）
- 复杂调试（需要深度推理）
- 并行处理多个独立任务
- 需要上下文隔离的任务

**❌ 不适合使用 SubAgent 的场景**：
- 简单的文件读取
- 单步操作
- 需要实时反馈的任务
- 上下文共享更方便的任务

### 任务派发原则

1. **明确任务目标**：给 SubAgent 清晰的任务描述
2. **限制工具权限**：只给必要的工具
3. **设置合理预期**：说明期望的输出格式
4. **控制并发数量**：避免过多并行 SubAgent

### SubAgent 配置模板

```json
{
  "name": "code-reviewer",
  "description": "专业的代码审查 SubAgent",
  "prompt": "你是代码审查专家，请审查指定文件的代码质量...",
  "allowed_tools": ["Read", "Grep", "Glob"],
  "model": "haiku"
}
```

### 常见陷阱

| 陷阱 | 问题 | 解决方案 |
|------|------|----------|
| **过度使用** | 简单任务也用 SubAgent | 评估任务复杂度再决定 |
| **工具过多** | 给了不必要的权限 | 使用最小权限原则 |
| **描述模糊** | SubAgent 不知道要做什么 | 提供清晰的任务描述 |
| **忽略成本** | Token 消耗过大 | 选择合适的模型 |

---

## 常见问题

### Q1: SubAgent 和 Agent 的本质区别是什么？

**核心区别是上下文**：
- **Agent**：在主上下文中执行，过程可见
- **SubAgent**：在独立上下文中执行，只返回结果

类比：Agent 是在开放办公室工作，SubAgent 是在独立办公室工作。

### Q2: 什么时候用 SubAgent 而不是直接让 Agent 做？

判断标准：
1. 任务是否会产生大量中间信息？
2. 任务是否需要深度推理和多步骤执行？
3. 主上下文是否已经很拥挤？

如果三个问题有 2 个以上是 YES，考虑使用 SubAgent。

### Q3: SubAgent 可以调用另一个 SubAgent 吗？

理论上可以，但**不推荐**：
- 增加复杂度
- 成本指数增长
- 难以调试

更好的做法：由主 Agent 统一调度多个 SubAgent。

### Q4: 如何为 SubAgent 选择模型？

| 任务类型 | 推荐模型 | 原因 |
|----------|----------|------|
| 代码探索 | Haiku | 只读任务，成本优先 |
| 代码修改 | Sonnet/Opus | 需要高质量输出 |
| 复杂推理 | Opus | 需要最强推理能力 |
| 简单任务 | Haiku | 成本控制 |

---

## 相关文档

### 核心概念
- [[01-基础概念/人工智能重要的六大概念体系]] - 六大概念总览
- [[01-基础概念/Prompt提示词]] - SubAgent 接收派发的 Prompt 任务
- [[01-基础概念/Agent智能体]] - SubAgent 由 Agent 派发和管理
- [[01-基础概念/MCP协议]] - SubAgent 可配置专属的 MCP 工具集
- [[01-基础概念/Skills 是什么]] - Skills 共享上下文，SubAgent 独立上下文
- [[01-基础概念/Agent Teams智能体团队]] - Agent Teams 是多 Agent 协作，SubAgent 是单 Agent 内的子任务

### 实践指南
- [[04-高级应用/Claude Subagent 使用指南]] - SubAgent 实战

---

## 参考资料

- [Claude Code 官方文档](https://docs.anthropic.com/claude-code)
- [Claude Code SubAgent 指南](https://code.claude.com/docs/subagents)
- [Anthropic: Building Effective Agents](https://www.anthropic.com/research/building-effective-agents)
